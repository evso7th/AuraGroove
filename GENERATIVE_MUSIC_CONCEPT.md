# Концепция: "Музыкальный Геном" и "Эволюционный Движок"

Этот документ описывает архитектурный подход к созданию постоянно развивающейся, но стилистически целостной генеративной музыки в приложении AuraGroove.

## Ключевые принципы

1.  **Уникальность Сессии:** Каждый запуск должен быть неповторим.
2.  **Стилистическая Целостность:** Развитие происходит внутри заданных гармонических и ритмических рамок стиля (например, "эмбиент не должен мутировать в хард-рок").
3.  **Заметная, но Планомерная Эволюция:** Мутация должна быть слышна, но не должна быть хаотичной или слишком быстрой.
4.  **Возвращение к "Якорям":** Способность возвращаться к знакомым темам и начинать с них новый виток развития — это то, что создает драматургию.
5.  **Продвинутые Алгоритмы:** Для реализации сложной логики мутаций будут использоваться подходы, основанные на фракталах, L-системах и цепях Маркова.

## Реализация в Worker'е

Вся логика будет инкапсулирована внутри `ambient.worker.ts` без изменения UI или основной логики приложения. Будут введены два новых компонента: `MusicalGenome` и `EvolutionEngine`.

### 1. `MusicalGenome` (Музыкальный Геном)

*   **Назначение:** Этот объект создается один раз в начале каждой музыкальной сессии и содержит уникальный набор "генов" для нее.
*   **Структура "генов":**
    *   **Базовая Гармоническая Последовательность:** Уникальная, но гармонически правильная последовательность из 4-8 аккордов, сгенерированная, например, с помощью **цепей Маркова**. Это обеспечивает уникальное начало каждой сессии.
    *   **Набор Ритмических Паттернов:** Несколько базовых ритмических рисунков для баса и ударных.
    *   **Начальная Мелодическая Фраза (Аксиома):** Короткая, простая мелодия из 3-5 нот, которая станет отправной точкой для L-системы и "якорем" для возврата.

### 2. `EvolutionEngine` (Эволюционный Движок)

*   **Назначение:** Главный дирижер мутации, работающий на каждом "тике" `Scheduler`'а.
*   **Функции:**
    *   **Управление L-системой для Мелодии:** На каждой итерации (или раз в несколько тактов) движок применяет правила L-системы к "начальной фразе" из генома, генерируя новые, более сложные, но родственные мелодии. Правила могут включать: "удвоить ноту", "добавить ноту на терцию выше", "инвертировать фрагмент".
    *   **Управление Фрактальной Структурой:** Движок использует простой фрактальный алгоритм для управления **динамикой** и **плотностью** аранжировки. В зависимости от текущей точки на фрактальной кривой, он будет решать:
        *   Добавить или убрать инструменты (аккомпанемент, эффекты).
        *   Изменить ритмическую активность баса.
        *   Сбросить L-систему к ее первоначальной "аксиоме", обеспечивая возврат к знакомой теме для нового витка развития.
    *   **Обеспечение Стилистической Целостности:** Все сгенерированные ноты (мелодии, аккорды) всегда проверяются на принадлежность к ладу, определенному в "геноме".

### Итог

Генераторы инструментов (`SoloGenerator`, `BassGenerator` и т.д.) становятся простыми "исполнителями". Они запрашивают партитуру у `EvolutionEngine`, который генерирует ее на основе уникального `MusicalGenome` текущей сессии. Это создает бесконечное, но структурированное и осмысленное музыкальное полотно.