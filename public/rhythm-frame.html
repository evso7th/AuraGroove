
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Engine</title>
    <script src="/assets/vendor/tone/Tone.js"></script>
</head>
<body>
    <script>
        console.log('[RHYTHM FRAME] HTML loaded.');

        let isAudioReady = false;
        let bassSynth = null;
        
        function setupInstruments() {
            console.log('[RHYTHM FRAME] Setting up instruments...');
            try {
                // Create a single, simple synth for the test
                bassSynth = new Tone.MonoSynth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 }
                }).toDestination();
                
                console.log('[RHYTHM FRAME] Instruments are ready.');
                return true;
            } catch (e) {
                console.error('[RHYTHM FRAME] Error setting up instruments:', e);
                window.parent.postMessage({ type: 'error', error: 'Failed to create Tone.js instruments: ' + e.message }, '*');
                return false;
            }
        }
        
        function scheduleScore(payload) {
            if (!isAudioReady || !bassSynth) return;
            const { score } = payload;
            
            // For this test, we play immediately to check the data pipeline.
            // We ignore complex transport scheduling for now.
            if (score && score.bassScore && score.bassScore.length > 0) {
                const note = score.bassScore[0];
                try {
                    bassSynth.triggerAttackRelease(note.note, note.duration, Tone.now(), note.velocity);
                } catch(e) {
                     console.error('[RHYTHM FRAME] Error playing note:', e);
                }
            }
        }

        window.addEventListener('message', async (event) => {
            if (!event.data || !event.data.command) return;

            const { command, payload } = event.data;
            
            switch (command) {
                case 'init':
                    if (isAudioReady) return;
                    console.log('[RHYTHM FRAME] Received init. Starting AudioContext...');
                    try {
                        await Tone.start();
                        console.log('[RHYTHM FRAME] AudioContext started.');
                        if (setupInstruments()) {
                           isAudioReady = true;
                           window.parent.postMessage({ type: 'rhythm_frame_ready' }, '*');
                        }
                    } catch (e) {
                        console.error('[RHYTHM FRAME] Error starting AudioContext:', e);
                        window.parent.postMessage({ type: 'error', error: e.message }, '*');
                    }
                    break;
                case 'start':
                    if (isAudioReady) Tone.Transport.start();
                    break;
                case 'stop':
                    if (isAudioReady) {
                        Tone.Transport.stop();
                        Tone.Transport.cancel();
                    }
                    break;
                case 'schedule':
                    scheduleScore(payload);
                    break;
            }
        });
    </script>
</body>
</html>
