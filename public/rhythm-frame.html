<!DOCTYPE html>
<html>
<head>
    <title>Rhythm Frame</title>
    <script src="/assets/vendor/tone/Tone.js"></script>
</head>
<body>
    <script>
        console.log('[RHYTHM FRAME] HTML loaded.');

        let isInitialized = false;
        let bassSynth;

        function setupInstruments() {
            console.log('[RHYTHM FRAME] Setting up instruments...');
            try {
                bassSynth = new Tone.MonoSynth({
                    oscillator: { type: 'fmsine' },
                    envelope: { attack: 0.1, release: 1 },
                }).toDestination();
                console.log('[RHYTHM FRAME] Instruments are ready.');
                return true;
            } catch (e) {
                console.error('[RHYTHM FRAME] Error setting up instruments:', e);
                window.parent.postMessage({ type: 'error', error: 'Instrument setup failed: ' + e.message }, '*');
                return false;
            }
        }

        function scheduleScore(payload) {
            if (!isInitialized || !payload || !payload.score || !payload.score.bassScore) return;
            
            const time = Tone.now();
            const bassScore = payload.score.bassScore;

            if (bassScore.length > 0) {
                 const note = bassScore[0];
                 // Play immediately for testing
                 bassSynth.triggerAttackRelease(note.note, note.duration, time, note.velocity);
            }
        }

        window.onmessage = async (event) => {
             if (!event.data || !event.data.command) return;
             const { command, payload } = event.data;

            switch(command) {
                case 'init':
                    if (isInitialized) return;
                    console.log('[RHYTHM FRAME] Received init. Starting AudioContext...');
                    try {
                        await Tone.start();
                        console.log('[RHYTHM FRAME] AudioContext started.');
                        if (setupInstruments()) {
                           isInitialized = true;
                           window.parent.postMessage({ type: 'rhythm_frame_ready' }, '*');
                        }
                    } catch (e) {
                        console.error('[RHYTHM FRAME] Error starting AudioContext:', e);
                        window.parent.postMessage({ type: 'error', error: 'AudioContext start failed: ' + e.message }, '*');
                    }
                    break;
                
                case 'start':
                    if(isInitialized && Tone.Transport.state !== 'started') Tone.Transport.start();
                    break;

                case 'stop':
                    if(isInitialized && Tone.Transport.state === 'started') Tone.Transport.stop();
                    break;

                case 'schedule':
                    if(isInitialized) {
                        scheduleScore(payload);
                    }
                    break;
            }
        };
    </script>
</body>
</html>
