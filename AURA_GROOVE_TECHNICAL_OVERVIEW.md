# AuraGroove: Технический обзор проекта

## 1. Ключевая архитектурная концепция: "Композитор-Исполнитель"

Проект построен на гибридной архитектуре "Композитор-Исполнитель", где логика генерации музыки и ее воспроизведения строго разделена между Web Worker'ом и основным потоком UI для достижения максимальной производительности и отзывчивости.

*   **Композитор (Web Worker - `src/app/ambient.worker.ts`):** Это "мозг" приложения. Он не создает звук. Его единственная задача — по расписанию (`tick`) генерировать "партитуры" (массивы нот с точным временем и параметрами) для каждого инструмента (соло, бас, аккомпанемент, ударные, эффекты). Он основывается на выбранном пользователем стиле (`dreamtales` или `promenade`) и настройках (BPM, активные инструменты). Для основного генеративного стиля `dreamtales` он использует **`EvolutionEngine`** для создания постоянно развивающихся музыкальных партий.

*   **Исполнители (Основной поток - `src/components/aura-groove.tsx` и менеджеры):** Это "сердце" и "руки" приложения.
    *   **`aura-groove.tsx`:** Главный React-компонент, являющийся "единым источником правды" для состояния UI. Он получает готовые партитуры от Worker'а и делегирует их воспроизведение соответствующим менеджерам.
    *   **Менеджеры синтезаторов (`*-synth-manager.ts`):** Каждый менеджер (`SoloSynthManager`, `AccompanimentSynthManager`, `BassSynthManager`) является фасадом, который инкапсулирует сложную логику управления пулом голосов `Tone.js`. Они получают ноты и отвечают за их своевременное и качественное звучание.
    *   **`DrumMachine.ts`:** Управляет воспроизведением сэмплов ударных через `Tone.Sampler`.
    *   **`EffectsSynthManager.ts`:** Управляет синтезаторами для спецэффектов.

## 2. Потоки данных и сообщений: "Дирижер" и "Брокер"

Система обмена информацией в проекте имеет два уровня:

*   **Внешний обмен (UI ↔ Worker):** Роль "брокера сообщений" выполняет сам глобальный объект Worker'а.
    *   **`self.onmessage`:** Единая точка входа для всех команд от UI (`start`, `stop`, `update_settings`).
    *   **`self.postMessage`:** Единый канал для отправки сгенерированных партитур (`drum_score`, `solo_score` и т.д.) обратно в UI.

*   **Внутренняя коммуникация в Worker'е:** Внутри `ambient.worker.ts` **отсутствует асинхронная шина сообщений**. Компоненты (`EvolutionEngine`, `DrumGenerator`) не обмениваются сообщениями между собой. Вместо этого используется паттерн **"Дирижер"**:
    *   **`Scheduler`:** Выступает в роли центрального дирижера. В каждом `tick` он напрямую и **синхронно** вызывает методы у нужных генераторов, собирает партитуры и отправляет их в основной поток. Такая архитектура упрощает логику и обеспечивает предсказуемый порядок выполнения.

*   **Аудио-шина (`FxBus.ts`):** Важно отметить, что `FxBus` — это **исключительно аудио-микшер**, работающий в основном потоке. Он управляет маршрутизацией **звуковых сигналов** от синтезаторов к эффектам и мастер-каналу. Он не участвует в обмене сообщениями между компонентами.

## 3. Генеративный движок "Dreamtales": Эволюция на основе "Генома"

Основной генеративный режим `dreamtales` работает на принципах, изложенных в `GENERATIVE_MUSIC_CONCEPT.md`. Это не простое зацикливание, а постоянно развивающийся процесс.

*   **`MusicalGenome`:** При запуске сессии создается уникальный "геном" — набор базовых гармонических последовательностей (аккордов) и мелодических/ритмических "якорей" (опорных фраз). Это обеспечивает уникальность каждой сессии.
*   **`EvolutionEngine`:** Это главный композиционный движок. На каждом такте он:
    1.  Определяет текущую гармонию из "генома".
    2.  Берет мелодический "якорь" и применяет к нему простые правила **мутации**, создавая новую, но родственную мелодическую фразу для соло.
    3.  Генерирует аккорды и басовые партии на основе текущей гармонии и ритмического "якоря".
    4.  Периодически (раз в 8 тактов) возвращается к исходному "якорю", создавая ощущение музыкальной драматургии и предотвращая уход в полный хаос.

## 4. Управление звуком: Производительность и качество

Проект решает классические проблемы веб-аудио с помощью проверенных подходов, описанных в `TECHNICAL_OVERVIEW.md` (документе-референсе).

*   **Пул голосов (Voice Pool):** Вместо использования ресурсоемкого `Tone.PolySynth`, для соло и аккомпанемента применяются пулы из нескольких независимых `Tone.Synth`. Когда нужно сыграть ноту, менеджер берет свободный синтезатор из пула, а после отзвучания ноты возвращает его обратно. Это кардинально снижает нагрузку на процессор и устраняет щелчки и артефакты звука.
*   **Централизованный FX Bus (`FxBus.ts`):** Все инструменты направляются не напрямую в мастер-канал, а в свои собственные каналы внутри `FxBus`. Это позволяет гибко применять эффекты (Distortion, Chorus) как к отдельным инструментам, так и потенциально ко всей группе.
*   **Адаптивный микс:** Приложение определяет тип устройства (`use-device-type.ts`) и применяет разные профили громкости (`desktop` vs `mobile`) для синтезаторов, чтобы обеспечить более сбалансированное звучание на устройствах с разными акустическими возможностями.

## 5. Обзор ключевых модулей

*   **`aura-groove.tsx`:** Центральный узел управления UI и координации между Worker'ом и аудио-менеджерами.
*   **`ambient.worker.ts`:** Изолированный "композитор" и "дирижер" генерации музыки. Не имеет доступа к `Tone.js`, работает только с чистыми данными (массивами нот).
*   **`*-synth-manager.ts`:** Высокоуровневые обертки над `Tone.js`, скрывающие сложность управления синтезаторами и предоставляющие простой API (`triggerAttackRelease`, `setInstrument`).
*   **`FxBus.ts`:** Аудио-микшер, основанный на `Tone.Channel` и `Tone.Gain`, для маршрутизации и обработки звука.
*   **`drum-machine.ts`:** Отвечает за ударные, используя `Tone.Sampler` для качественного воспроизведения сэмплов.

## 6. Вывод

Проект "AuraGroove" представляет собой зрелую и хорошо спроектированную систему для генерации эмбиент-музыки. Он эффективно решает проблемы производительности в веб-аудио благодаря четкому разделению логики (Композитор/Исполнитель) и использованию пулов объектов. Генеративный движок, основанный на концепции "эволюции генома", позволяет создавать уникальные и немонотонные музыкальные полотна, что выгодно отличает его от простых луперов.