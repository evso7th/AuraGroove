# AuraGroove: Архитектурный паспорт (Финальная версия "Композитор в Воркере")

Этот документ описывает финальную, стабильную архитектуру проекта AuraGroove. Он служит техническим руководством, объясняющим, как взаимодействуют все компоненты системы для создания генеративной музыки с высокой производительностью и качеством звука.

## 1. Общая концепция: "Композитор в Воркере, Исполнители в Ворклетах"

Ключевая идея проекта — полное разделение логики **сочинения** музыки от логики ее **исполнения**. Это решает две фундаментальные проблемы веб-аудио:
1.  **Производительность UI:** Ресурсоемкая генерация музыки не "замораживает" основной поток, обеспечивая плавность интерфейса.
2.  **Качество звука:** Синтез звука происходит в высокоприоритетном аудио-потоке, что минимизирует риски щелчков, хрипов и задержек.

-   **Композитор (Web Worker - `src/lib/ambient.worker.ts`):** Это "мозг" приложения. Он работает в изолированном потоке и не занимается синтезом звука. Его задача — по команде `tick` из основного потока генерировать "партитуры" (массивы нот с точным временем) для всех инструментов. Он управляет плотностью аранжировки и выбором текстур.

-   **Исполнители (AudioWorklet-процессоры - `public/worklets/*.js`):** Это "руки" приложения. Вместо ресурсоемкого `Tone.js` в основном потоке, мы используем легковесные процессоры, работающие напрямую в аудио-потоке с низкой задержкой. Они получают простые команды (например, "сыграй ноту MIDI 60") и самостоятельно генерируют звук.

## 2. Псевдографическая схема архитектуры

```
+--------------------------------------------------------------------------------+
|                                  ОСНОВНОЙ ПОТОК (UI)                           |
|                                                                                |
| +----------------------+   (обновление UI,      +---------------------------+ |
| | UI-компонент         |<-> настройки)          | Hook                      | |
| | aura-groove.tsx      |----------------------->| useAuraGroove             | |
| +----------------------+                         +---------------------------+ |
|                                                         | (команды движку)     |
|                                                         |                      |
|                                                         V                      |
| +----------------------------------------------------------------------------+ |
| |                            Контекст: AudioEngineProvider                   | |
| |----------------------------------------------------------------------------| |
| |                                                                            | |
| | [КОМАНДА: update_settings] -------------------> [Web Worker]                | |
| |                                                  (ambient.worker.ts)       | |
| | [ОТВЕТ: 'score'] <------------------------------- [Композитор]              | |
| |   |                                                                        | |
| |   +---- [Партитура для Баса] -----> BassSynthManager ---[команда]--> [bass-processor.js] (AudioWorklet) |
| |   |                                                                        | |
| |   +---- [Партитура для Аккомп.] --> AccompanimentSynthManager --> [chord-processor.js] (AudioWorklet)|
| |   |                                                                        | |
| |   +---- [Команда 'sparkle'] ------> SparklePlayer --> (AudioBufferSourceNode) |
| |   |                                                                        | |
| |   +---- [Команда 'pad'] ----------> PadPlayer ------> (AudioBufferSourceNode) |
| |                                                                            | |
| +----------------------------------------------------------------------------+ |
+--------------------------------------------------------------------------------+

```

## 3. Компоненты системы: Подробный разбор

### 3.1. Пользовательский интерфейс (UI)

-   **`aura-groove.tsx`:** "Глупый" компонент, отвечающий только за отображение. Он получает все данные и функции-обработчики из хука.
-   **`useAuraGroove.ts`:** Хук, который управляет состоянием UI (значения слайдеров, выбранные инструменты) и является мостом между UI и аудио-движком.
-   **`AudioEngineProvider`:** React-контекст, который инкапсулирует всю логику аудио. Он инициализирует аудио-контекст, воркер, ворклеты и предоставляет простой API для управления (`play`, `stop`, `updateSettings`).

### 3.2. Композитор и Evolution Engine (Web Worker)

-   **`ambient.worker.ts`:** Пассивный "мозг". Он не имеет собственных таймеров и запускает генерацию только по команде `tick` из основного потока.
-   **`Composer`:** Внутренний объект, который на каждый `tick` вызывает методы для генерации партий баса, мелодии и аккомпанемента.
-   **`EvolutionEngine` (Концепция внутри `Composer`'а):** Это не отдельный класс, а набор принципов, заложенных в логику генерации:
    -   **Плотность (`density`):** Главный параметр, управляющий сложностью. `density` влияет на количество нот в мелодии, вероятность появления арпеджио в басовой партии и добавление дополнительных слоев в аккомпанемент.
    -   **Гармоническая согласованность:** Все партии генерируются в рамках одной тональности (E-минор), что обеспечивает их благозвучное сочетание.
    -   **Пошаговое движение:** Мелодия развивается по принципу "случайного блуждания" вверх или вниз по гамме, что создает непредсказуемую, но логичную линию.
    -   **Текстурная генерация:** Вместо игры аккордов, создающей пиковую нагрузку, аккомпанемент генерирует несколько асинхронных монофонических линий. За счет длинного `release` у синтезаторов их звучание перекрывается, создавая плотную, обволакивающую текстуру без перегрузки CPU.

### 3.3. Исполнители (Менеджеры и Ворклеты)

-   **`BassSynthManager` / `bass-processor.js`:**
    -   **Менеджер:** Получает партитуру для баса и отправляет команды в ворклет. Он также отвечает за переключение пресетов и техник.
    -   **Ворклет (`bass-processor`):** Настоящий синтезатор. Он инкапсулирует два осциллятора и фильтр. При получении команды `noteOn` он сам генерирует звук. Ворклет поддерживает несколько режимов (`mode`):
        -   **`arpeggio`, `portamento`, `glide`:** Стандартные техники исполнения.
        -   **`pulse`:** Получив одну ноту, ворклет самостоятельно запускает внутренний генератор, который производит серию очень коротких и быстрых импульсов (1/32), создавая плотную, вибрирующую текстуру без нагрузки на основной поток.

-   **`AccompanimentSynthManager` / `chord-processor.js`:**
    -   **Менеджер:** Управляет пресетами для аккомпанемента.
    -   **Ворклет (`chord-processor`):** Специализированный ворклет для проигрывания аккордов с "живым" исполнением. При получении массива нот он проигрывает их не идеально одновременно, а с небольшой задержкой (`stagger`), создавая эффект мягкого взятия аккорда.

### 3.4. Текстурные плееры (Sparkles & Pads)

-   **`SparklePlayer.ts`:** Управляет воспроизведением коротких, случайных звуковых эффектов ("искорок"), которые добавляют в музыку элемент неожиданности. Он получает команду от воркера и проигрывает случайный сэмпл из своего пула через `AudioBufferSourceNode`.
-   **`PadPlayer.ts`:** Управляет фоновыми, зацикленными пэдами. При смене стиля происходит плавный 5-секундный кроссфейд между старым и новым пэдом.

## 4. Заметка о сэмплерных пэдах: Костыль для несовершенного мира

Может возникнуть вопрос: если система синтеза настолько самодостаточна, зачем нужны заранее записанные сэмплы пэдов?

Ответ кроется в суровой реальности: **убожество акустических систем основной массы смартфонов.**

Встроенные динамики телефонов физически не способны воспроизвести богатый низкочастотный и среднечастотный спектр, который генерируют наши синтезаторы. При прослушивании через них, музыка теряет "тело", "тепло" и "обволакивающий эффект", превращаясь в "писклявый" набор нот.

Сэмплерные пэды (`PadPlayer`) — это архитектурный "костыль", осознанный компромисс, решающий эту проблему. Эти пэды:
-   **Прошли мастеринг:** Они специально обработаны так, чтобы их ключевые гармоники попадали в тот узкий частотный диапазон, который могут воспроизвести даже самые простые динамики.
-   **Создают "Иллюзию Баса":** Они добавляют психоакустическую основу, которую пользователь не слышит, но "ощущает", компенсируя отсутствие реальных низких частот.

**Важно:** С хорошей акустикой (наушники или внешние колонки) в этих пэдах нет никакой нужды. Система синтеза абсолютно самодостаточна и создает гораздо более глубокий и детализированный звуковой ландшафт. Пэды — это вспомогательный элемент, который **поддерживает воспринимаемое качество звука** на устройствах низкого класса, но не является ядром музыкальной системы.
