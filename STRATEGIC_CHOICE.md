# Стратегический выбор: Два пути к чистому звуку

Этот документ является результатом ретроспективы и мета-анализа. Он предлагает две независимые, взаимоисключающие стратегии для достижения главной цели проекта: богатого, обволакивающего и абсолютно чистого звука на всех устройствах.

---

## Проект 1: "Легион" (Путь Чистых Голосов)

**Философия:** "Никогда не доверяй старому голосу". Мы принимаем урок от `KeyboardAccordion.com` и строим нашу архитектуру на принципе эфемерности. Каждый звук должен рождаться и умирать в своем собственном, чистом, изолированном окружении.

**Техническая реализация:**

1.  **Полный отказ от менеджеров-одиночек:** `MelodySynthManager` и `BassSynthManager` в их текущем виде упраздняются. Хранить постоянный `Tone.Synth` для переиспользования — запрещено.
2.  **Внедрение Пула Голосов:** Вместо них создается единый `VoicePoolManager`. Этот менеджер будет управлять ограниченным количеством (например, 16) объектов `Voice`.
3.  **Класс `Voice`:** Это обертка над `Tone.Synth`. Его задача — родиться, сыграть одну ноту (или короткую фразу через `triggerAttackRelease`) и умереть (быть помеченным как "свободный").
4.  **Новая логика `schedule`:**
    *   Основной поток получает от воркера партитуру (массив нот).
    *   Для **каждой ноты** в партитуре он запрашивает у `VoicePoolManager` свободный `Voice`.
    *   Менеджер находит свободный голос, настраивает его нужным пресетом (`portamento`, `bassGuitar` и т.д.) и отдает команду `triggerAttackRelease`.
    *   После того как нота отыграла, голос автоматически помечается как свободный.
5.  **Сохранение `DrumMachine`:** `DrumMachine` работает по схожему принципу (используя `Tone.Players` для сэмплов) и остается без изменений.

**Преимущества "Легиона":**
*   **Абсолютная чистота звука:** Каждая нота играется новым, "чистым" экземпляром синтезатора. Нет конфликтов состояний, нет "грязных" осцилляторов.
*   **Низкоуровневый контроль:** Это самый близкий к "ванильному" Web Audio API подход, который можно реализовать с `Tone.js`.
*   **Надежность:** Архитектура проста для понимания и отладки. Есть нота — есть голос. Нет ноты — голос свободен.

**Недостатки и риски "Ле-гиона":**
*   **Производительность:** Создание нового `Tone.Synth` на каждую ноту может быть ресурсоемким. Хотя это гораздо лучше, чем конфликт состояний, на очень слабых устройствах при плотной аранжировке мы можем снова столкнуться с перегрузкой CPU.
*   **Сложность для "длинных" звуков:** Управление длинными, эволюционирующими звуками (дроунами) становится сложнее. Нужно будет привязывать конкретный голос к конкретному дроуну, что усложнит логику пула.

---

## Проект 2: "Конвейер" (Путь Оффлайн-Рендеринга)

**Философия:** "Не заставляй дирижера делать работу студийного инженера". Мы полностью разделяем процесс **сочинения/сведения** и процесс **воспроизведения**. Основной поток не должен знать ничего о синтезе. Он должен работать как обычный MP3-плеер.

**Техническая реализация:**

1.  **Воркер становится "Студией":**
    *   `ambient.worker.ts` полностью меняет свою роль. При получении команды `tick` он **не отправляет партитуру**.
    *   Вместо этого он использует свою копию `Tone.js` (это возможно, но требует аккуратной настройки) для рендеринга **всей синтезаторной части** (бас, мелодия, эффекты) в аудио-буфер `Float32Array`.
    *   В основной поток отправляется сообщение `{ type: 'synth_chunk', data: { buffer: ..., duration: ... } }`
2.  **Основной поток становится "Плеером":**
    *   Мы **полностью удаляем** `MelodySynthManager` и `BassSynthManager`.
    *   Мы создаем новый, простой класс `AudioPlayer`, который управляет очередью `AudioBufferSourceNode`.
    *   `audio-engine-context` получает аудио-буфер от воркера и просто передает его в `AudioPlayer` для планирования на следующий такт.
3.  **Гибридная модель с `DrumMachine`:**
    *   `DrumMachine` **остается в основном потоке**.
    *   Воркер, помимо аудио-буфера, отправляет и партитуру для ударных (`drumScore`).
    *   Основной цикл одновременно планирует воспроизведение аудио-буфера (через `AudioPlayer`) и партию ударных (через `DrumMachine`).

**Преимущества "Конвейера":**
*   **Максимальная производительность UI:** Основной поток выполняет только две легкие задачи: планирование ударных и запуск воспроизведения готового аудиофайла. Это гарантирует отсутствие "хрипов" даже при самых сложных синтезаторных партиях на самых слабых устройствах.
*   **Творческая свобода:** Воркер может создавать сколь угодно сложные звуковые текстуры, не оглядываясь на производительность основного потока.
*   **Масштабируемость:** Эта архитектура является стандартом для профессиональных веб-аудио приложений.

**Недостатки и риски "Конвейера":**
*   **Сложность реализации:** Заставить `Tone.js` корректно работать внутри воркера для оффлайн-рендеринга — нетривиальная задача. Могут возникнуть проблемы с контекстом и зависимостями.
*   **Латентность:** Может появиться небольшая задержка между действием пользователя (например, сменой стиля) и изменением звука, так как воркеру нужно время, чтобы отрендерить новый аудио-буфер.
*   **Меньшая интерактивность:** Прямое взаимодействие с синтезаторами из основного потока (например, для ручной игры поверх автопилота) становится невозможным.

---

**Резюме Мета-Наблюдателя:**

*   **Проект "Легион"** — это эволюционный, более безопасный и быстрый в реализации путь. Он решает нашу главную проблему (конфликт состояний), но может оставить проблему производительности на очень слабых устройствах.
*   **Проект "Конвейер"** — это революционный, более сложный и рискованный путь. Он решает **все** наши проблемы с производительностью раз и навсегда, но требует значительно больших трудозатрат и имеет свои компромиссы.

Выбор между этими двумя проектами — это стратегический выбор между надежным, пошаговым улучшением и рискованным, но потенциально более мощным прорывом.